steps:
  - script: |
      echo "Running Trivy scan (fail only on CRITICAL)"

      trivy image \
        --ignorefile $(Build.SourcesDirectory)/.trivyignore \
        --ignore-unfixed \
        --severity CRITICAL \
        --exit-code 0 \
        --no-progress \
        "$(dockerRegistry)/$(dockerImageName):latest" | tee trivy_output.txt

      echo "Checking for CRITICAL vulnerabilities..."
      if grep -q "CRITICAL" trivy_output.txt; then
        echo "❌ CRITICAL vulnerabilities found"
        exit 1
      else
        echo "✅ No CRITICAL vulnerabilities found"
      fi
    displayName: "Trivy Scan on ACR Image"
