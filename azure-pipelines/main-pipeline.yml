trigger:
  - main

pool:
  name: SelfHostedPool

variables:
  # ACR credentials
  ACR_USERNAME: django1
  dockerRegistry: django1.azurecr.io
  dockerImageName: django

  # Secrets should be defined in the pipeline UI only
  # Do NOT redefine them here with $(VAR) ‚Äî that causes self-reference issues
  # ACR_PASSWORD and SONAR_TOKEN must be added in the pipeline UI as secret variables

  # Non-secret variable can be defined inline
  SONAR_HOST_URL: http://52.233.85.186:9000

stages:

  - stage: Checkout
    displayName: Checkout Code
    jobs:
      - job: checkout
        steps:
          - template: templates/checkout.yml

  - stage: InstallDependencies
    displayName: Install Dependencies
    jobs:
      - job: install
        steps:
          - template: templates/install_dependencies.yml

  - stage: UnitTesting
    displayName: Unit Tests
    jobs:
      - job: unitTests
        steps:
          - template: templates/unit_testing.yml

  - stage: CodeCoverage
    displayName: Code Coverage
    jobs:
      - job: coverage
        steps:
          - template: templates/code_coverage.yml

  - stage: CredentialScanning
    displayName: Secret Scan
    jobs:
      - job: credScan
        steps:
          - template: templates/cred_scanning.yml

  - stage: DependencyScanning
    displayName: Dependency Scan
    jobs:
      - job: dependencyScan
        steps:
          - template: templates/dependency_scanning.yml

  - stage: StaticAnalysis
    displayName: Static Analysis
    dependsOn:
      - UnitTesting
      - CodeCoverage
    jobs:
      - job: sonar
        steps:
          - template: templates/static_analysis.yml

  - stage: QualityGates
    displayName: SonarQube Quality Gate Check
    dependsOn: StaticAnalysis
    condition: succeededOrFailed()
    jobs:
      - job: qualityGate
        steps:
          - template: templates/quality_gates.yml

  # ---------------------------------------------------
  # üöÄ Docker Build & Push
  # ---------------------------------------------------
  - stage: DockerBuild
    displayName: Docker Build & Push
    dependsOn: QualityGates
    jobs:
      - job: buildDocker
        displayName: Build & Push Docker Image
        steps:

          # Debug to confirm variables are loaded
          - script: |
              echo "dockerRegistry = $dockerRegistry"
              echo "dockerImageName = $dockerImageName"
            displayName: "DEBUG DOCKER VARIABLES"

          # Login to ACR using service connection
          - task: Docker@2
            displayName: Login to ACR
            inputs:
              command: login
              containerRegistry: Django   # name of your ACR service connection in DevOps

          # Build & Push using template (docker_push.yml)
          - template: templates/docker_push.yml

  # ---------------------------------------------------
  # üõ°Ô∏è Trivy Scan
  # ---------------------------------------------------
  - stage: TrivyScan
    displayName: Trivy Vulnerability Scan
    dependsOn: DockerBuild
    jobs:
      - job: scanDockerImage
        displayName: Scan Docker Image in ACR
        steps:
          # Login to ACR before scanning
          - task: Docker@2
            displayName: Login to ACR
            inputs:
              command: login
              containerRegistry: Django

          # Run Trivy scan using template
          - template: templates/trivy_scan.yml
